<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Auras - Status Code 418</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase Modules -->
    <script type="module" src="assets/js/firebase-config.js"></script>
    <script type="module" src="assets/js/firebase-storage.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/auras.css">
    <style>
        /* Tokyo Night Theme */
        :root {
            --background: #1a1b26;
            --foreground: #a9b1d6;
            --card-background: #24283b;
            --border: #414868;
            --accent: #7aa2f7;
            --yellow: #e0af68;
            --red: #f7768e;
            --green: #9ece6a;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .background-day, .background-night {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0; transition: opacity 1s ease;
        }
        .background-day { background-image: url('https://i.pinimg.com/originals/71/f1/b9/71f1b924a56150104ec16828f2d31b7f.gif'); }
        .background-night { background-image: url('https://i.pinimg.com/originals/4c/23/98/4c2398e6be397bb08b5cb70b2192d730.gif'); }
        .dark .background-night { opacity: 1; }
        :not(.dark) .background-day { opacity: 1; }
        
        .glass-panel {
            background-color: rgba(36, 40, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
        }

        .xp-display {
            background: linear-gradient(135deg, var(--card-background), #1f2335);
            border: 1px solid var(--accent);
            box-shadow: 0 0 20px rgba(122, 162, 247, 0.2);
        }
    </style>
</head>
<body class="p-6 md:p-12">
    
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div class="flex items-center gap-4">
                <a href="menu_inicio.html" class="p-3 bg-card-background rounded-full hover:bg-accent hover:text-white transition group">
                    <i data-lucide="arrow-left" class="w-6 h-6 group-hover:-translate-x-1 transition-transform"></i>
                </a>
                <div>
                    <h1 class="text-4xl font-bold text-white flex items-center gap-3">
                        <i data-lucide="sparkles" class="text-accent"></i> Tienda de Auras
                    </h1>
                    <p class="text-gray-400">Personaliza tu perfil con efectos visuales de alta calidad.</p>
                </div>
            </div>

            <div class="xp-display px-8 py-4 rounded-2xl flex items-center gap-4">
                <div class="text-right">
                    <p class="text-sm text-gray-400 uppercase tracking-widest">Saldo Actual</p>
                    <p class="text-3xl font-bold text-yellow font-mono" id="user-coins">0 ðŸª™</p>
                </div>
                <i data-lucide="coins" class="w-10 h-10 text-yellow"></i>
            </div>
        </header>

        <!-- Auras Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold mb-6 text-accent border-b border-gray-700 pb-2 flex items-center gap-2">
                <i data-lucide="zap"></i> CatÃ¡logo de Auras
            </h2>
            <div id="auras-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Cargando... -->
                <div class="col-span-full text-center text-gray-500 animate-pulse">Cargando auras del sistema...</div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 border border-accent text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i data-lucide="check-circle" class="text-green-400"></i>
        <span id="toast-msg">AcciÃ³n completada</span>
    </div>

    <script type="module">
        import { doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { db } from './assets/js/firebase-config.js';
        // Import unified data
        import { PROFILE_AURAS } from './assets/js/predefined-profiles.js';

        let currentUser = null;
        let currentCoins = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadUser();
            renderStore();
        });

        async function loadUser() {
            const localUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!localUser) { window.location.href = 'index.html'; return; }

            // Fetch fresh from Firebase if possible to confirm Balance
            if (window.getUserFromFirestore) {
                try {
                    currentUser = await window.getUserFromFirestore(localUser.id);
                } catch(e) { currentUser = localUser; }
            } else {
                currentUser = localUser;
            }

            // Init coins/inventory if not present
            if (currentUser.coins === undefined) currentUser.coins = 0;
            if (!currentUser.inventory) currentUser.inventory = { auras: [] };
            if (!currentUser.inventory.auras) currentUser.inventory.auras = [];

            currentCoins = currentUser.coins;

            updateCoinDisplay();
        }

        function updateCoinDisplay() {
            document.getElementById('user-coins').textContent = `${currentCoins} ðŸª™`;
        }

        function renderStore() {
            renderAuras();
            lucide.createIcons();
        }

        function renderAuras() {
            const grid = document.getElementById('auras-grid');
            grid.innerHTML = '';
            
            const inventory = currentUser.inventory?.auras || [];
            const equipped = currentUser.equippedAura;
            const achievements = currentUser.achievements || [];

            // Grouping Logic
            const tiers = {
                'Tier 1: ComÃºn (500 ðŸª™)': [],
                'Tier 2: Raro (2000 ðŸª™)': [],
                'Tier 3: Ã‰pico (5000 ðŸª™)': [],
                'Tier 4: Legendario (10000 ðŸª™)': [],
                'Exclusivos de Curso (Nivel 20)': [],
                'Logros': [],
                'Secretos (???)': [],
                'Fundadores (God Tier)': []
            };

            PROFILE_AURAS.forEach(aura => {
                if (aura.id.startsWith('aura-c-')) tiers['Tier 1: ComÃºn (500 ðŸª™)'].push(aura);
                else if (aura.id.startsWith('aura-r-')) tiers['Tier 2: Raro (2000 ðŸª™)'].push(aura);
                else if (aura.id.startsWith('aura-e-')) tiers['Tier 3: Ã‰pico (5000 ðŸª™)'].push(aura);
                else if (aura.id.startsWith('aura-l-')) tiers['Tier 4: Legendario (10000 ðŸª™)'].push(aura);
                else if (aura.id.startsWith('aura-course-')) tiers['Exclusivos de Curso (Nivel 20)'].push(aura);
                else if (aura.id.startsWith('aura-ach-')) tiers['Logros'].push(aura);
                else if (aura.id.startsWith('aura-secret-')) tiers['Secretos (???)'].push(aura);
                else if (aura.id.startsWith('aura-founder-')) tiers['Fundadores (God Tier)'].push(aura);
                else tiers['Tier 1: ComÃºn (500 ðŸª™)'].push(aura); // Fallback
            });

            // Render Groups
            for (const [tierName, auras] of Object.entries(tiers)) {
                if(auras.length === 0) continue;

                // Section Header
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'col-span-full mt-8 mb-4 border-b border-gray-700 pb-2';
                sectionHeader.innerHTML = `<h3 class="text-xl font-bold text-gray-300 uppercase tracking-wider">${tierName}</h3>`;
                grid.appendChild(sectionHeader);

                // Cards
                auras.forEach(aura => {
                    const isOwned = inventory.includes(aura.id);
                    const isEquipped = equipped === aura.id;
                    const price = aura.price;
                    const canAfford = currentCoins >= price;

                    // Unlock Condition Check
                    let isLocked = false;
                    let lockedReason = '';

                    if (aura.unlockCondition) {
                        if (aura.unlockCondition === 'is_steven') {
                            if (!currentUser.id.includes('steven') && !achievements.includes('founder_badge')) {
                                isLocked = true;
                                lockedReason = 'Exclusivo Fundador';
                            }
                        } else if (aura.unlockCondition === 'is_amelia') {
                            if (!currentUser.id.includes('amelia')) {
                                isLocked = true;
                                lockedReason = 'Exclusivo Co-Fundador';
                            }
                        } else if (aura.unlockCondition.startsWith('course_')) {
                             if (!isOwned) {
                                 // Check achievement badge for course
                                 // We assume there's a badge like 'badge_web_master' etc.
                                 // For now, if they don't own the aura, we lock it telling them to finish the course.
                                 isLocked = true;
                                 lockedReason = 'Completa el Curso (Nvl 20)';
                             }
                        } else if (aura.unlockCondition.startsWith('secret_')) {
                            if (!isOwned && !achievements.includes(aura.unlockCondition)) { // Assuming secret unlocks give an achievement or flag with same name
                                isLocked = true;
                                lockedReason = '??? (Secreto)';
                            }
                        } else if (!achievements.includes(aura.unlockCondition)) {
                            isLocked = true;
                            lockedReason = 'Logro Requerido';
                        }
                    }

                    if (isOwned) isLocked = false;

                    const card = document.createElement('div');
                    card.className = `glass-panel p-6 flex flex-col items-center text-center transition-all hover:-translate-y-2 relative overflow-hidden ${isOwned ? 'border-accent shadow-[0_0_15px_rgba(122,162,247,0.3)]' : canAfford && !isLocked ? 'border-gray-600' : 'border-red-900/50 opacity-80'}`;
                    
                    // Button Logic
                    let btnHtml = '';
                    if (isEquipped) {
                        btnHtml = `<button class="w-full py-2 bg-green-600/20 text-green-400 border border-green-500 rounded-lg font-bold cursor-default flex justify-center items-center gap-2"><i data-lucide="check"></i> Equipado</button>`;
                    } else if (isOwned) {
                        btnHtml = `<button onclick="window.equipAura('${aura.id}')" class="w-full py-2 bg-accent text-white rounded-lg font-bold hover:bg-accent-dark transition shadow-lg shadow-accent/20">Equipar</button>`;
                    } else if (isLocked) {
                        btnHtml = `<button disabled class="w-full py-2 bg-gray-800 text-gray-500 border border-gray-700 rounded-lg font-bold cursor-not-allowed text-xs flex flex-col items-center justify-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> ${lockedReason}</button>`;
                    } else if (canAfford) {
                        btnHtml = `<button onclick="window.buyAura('${aura.id}', ${price})" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-bold transition flex justify-center items-center gap-2 shadow-lg shadow-yellow-600/20"><i data-lucide="shopping-cart" class="w-4 h-4"></i> Comprar</button>`;
                    } else {
                         btnHtml = `<button disabled class="w-full py-2 bg-gray-700 text-gray-400 rounded-lg font-bold cursor-not-allowed">Insuficiente</button>`;
                    }

                    // Price Badge
                    let priceDisplay = '';
                    if (price === 0 && !isOwned) priceDisplay = '<span class="text-green-400 font-bold">RECOMPENSA</span>';
                    else if (price === 0 && isOwned) priceDisplay = '<span class="text-gray-400 font-bold">ADQUIRIDO</span>';
                    else priceDisplay = `<span class="text-yellow-400 font-bold">${price} ðŸª™</span>`;

                    card.innerHTML = `
                        <div class="mb-6 mt-2 relative w-24 h-24 flex items-center justify-center mx-auto">
                            <div class="avatar-aura-container ${aura.cssClass}">
                                <img src="${currentUser.avatar || 'assets/default-avatar.png'}" class="w-20 h-20 rounded-full object-cover">
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-bold text-white mb-1">${aura.name}</h3>
                        <p class="text-xs text-gray-400 mb-4 h-8 flex items-center justify-center">${aura.desc}</p>
                        
                        <div class="font-mono text-lg mb-6 bg-black/30 px-4 py-1 rounded-full border border-white/10">
                            ${priceDisplay}
                        </div>
                        
                        <div class="mt-auto w-full">
                            ${btnHtml}
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            }
        }

        // --- ACTIONS ---

        window.buyAura = async (auraId, price) => {
             if (currentCoins < price) return;
            if(!confirm(`Â¿Comprar esta aura por ${price} Monedas?`)) return;

            const inventory = currentUser.inventory || { auras: [] };
            if (!inventory.auras) inventory.auras = [];
            
            if (inventory.auras.includes(auraId)) return;

            // Buy
            currentUser.coins = currentCoins - price;
            inventory.auras.push(auraId);

            // Save
            currentUser.inventory = inventory;
            await saveUser(currentUser);

            showToast(`Â¡Aura adquirida!`);
            currentCoins = currentUser.coins; // update local var
            updateCoinDisplay();
            renderStore();
        };

        window.equipAura = async (auraId) => {
            currentUser.equippedAura = auraId;
            await saveUser(currentUser);
            showToast('Â¡Aura equipada!');
            renderStore();
        };

        async function saveUser(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
             try {
                const userRef = doc(db, 'users', user.id);
                // Clean undefined
                const safeUser = JSON.parse(JSON.stringify(user));
                await updateDoc(userRef, {
                    coins: safeUser.coins,
                    inventory: safeUser.inventory,
                    equippedAura: safeUser.equippedAura
                });
            } catch(e) { console.error('Error saving to Firebase:', e); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-20');
            }, 3000);
        }

        // --- LÃ“GICA DE TEMA (DÃ­a/Noche) ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function updateTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            if (themeIcon) themeIcon.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            localStorage.setItem('theme', theme);
            if (window.lucide) lucide.createIcons();
        }

        // Initialize theme on load
        const savedTheme = localStorage.getItem('theme') || 'dark';
        updateTheme(savedTheme);

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                updateTheme(isDark ? 'light' : 'dark');
            });
        }
    </script>
</body>
</html>
