<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Marcos - Status Code 418</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase Modules -->
    <script type="module" src="assets/js/firebase-config.js"></script>
    <script type="module" src="assets/js/firebase-storage.js"></script>
    <style>
        /* Tokyo Night Theme */
        :root {
            --background: #1a1b26;
            --foreground: #a9b1d6;
            --card-background: #24283b;
            --border: #414868;
            --accent: #7aa2f7;
            --yellow: #e0af68;
            --red: #f7768e;
            --green: #9ece6a;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .glass-panel {
            background-color: rgba(36, 40, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
        }

        /* Frame Previews */
        .frame-preview {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        
        .frame-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Define Frames CSS directly here for preview */
        .frame-gold { box-shadow: 0 0 0 4px #e0af68, 0 0 20px rgba(224, 175, 104, 0.5); }
        .frame-neon { box-shadow: 0 0 0 4px #7aa2f7, 0 0 20px #7aa2f7, inset 0 0 10px #7aa2f7; }
        .frame-glitch { box-shadow: 3px 0 0 #f7768e, -3px 0 0 #7aa2f7; animation: glitch 1s infinite alternate; }
        .frame-fire { box-shadow: 0 0 0 4px #ff9f43, 0 -5px 15px #ff6b6b; animation: burn 1.5s infinite alternate; }
        .frame-matrix { box-shadow: 0 0 0 4px #9ece6a, 0 0 15px #9ece6a; border: 2px dashed #000; }
        
        /* Founder Frames (Not meant to be bought, but maybe shown as unavailable?) */
        .frame-steven { box-shadow: 0 0 0 4px #3b82f6, 0 0 30px rgba(59, 130, 246, 0.8); }
        .frame-amelia { box-shadow: 0 0 0 4px #f7768e, 0 0 30px rgba(247, 118, 142, 0.8); }

        @keyframes glitch { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } }
        @keyframes burn { 0% { box-shadow: 0 0 0 4px #ff9f43, 0 -5px 15px #ff6b6b; } 100% { box-shadow: 0 0 0 4px #ff9f43, 0 -2px 5px #ff6b6b; } }

        .xp-display {
            background: linear-gradient(135deg, var(--card-background), #1f2335);
            border: 1px solid var(--accent);
            box-shadow: 0 0 20px rgba(122, 162, 247, 0.2);
        }
    </style>
</head>
<body class="p-6 md:p-12">
    
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div class="flex items-center gap-4">
                <a href="menu_inicio.html" class="p-3 bg-card-background rounded-full hover:bg-accent hover:text-white transition group">
                    <i data-lucide="arrow-left" class="w-6 h-6 group-hover:-translate-x-1 transition-transform"></i>
                </a>
                <div>
                    <h1 class="text-4xl font-bold text-white flex items-center gap-3">
                        <i data-lucide="shopping-bag" class="text-accent"></i> Tienda de Marcos
                    </h1>
                    <p class="text-gray-400">Gasta tu XP ganada con sudor y cÃ³digo.</p>
                </div>
            </div>

            <div class="xp-display px-8 py-4 rounded-2xl flex items-center gap-4">
                <div class="text-right">
                    <p class="text-sm text-gray-400 uppercase tracking-widest">Tu Saldo</p>
                    <p class="text-3xl font-bold text-accent font-mono" id="user-xp">0 XP</p>
                </div>
                <i data-lucide="coins" class="w-10 h-10 text-yellow"></i>
            </div>
        </header>

        <!-- Grid -->
        <div id="frames-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8">
            <!-- Cargando... -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-900 border border-green-500 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i data-lucide="check-circle"></i>
        <span id="toast-msg">Compra exitosa</span>
    </div>

    <script type="module">
        import { doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        import { db } from './assets/js/firebase-config.js';

        // DEFINICIÃ“N DE PRODUCTOS
        const FRAMES = [
            { id: 'frame-gold', name: 'Aura Dorada', price: 500, desc: 'Brilla como el oro puro.', class: 'frame-gold' },
            { id: 'frame-neon', name: 'Cyber Neon', price: 1000, desc: 'Estilo high-tech.', class: 'frame-neon' },
            { id: 'frame-glitch', name: 'Error 418', price: 2000, desc: 'Un glitch en la matrix.', class: 'frame-glitch' },
            { id: 'frame-fire', name: 'Fuego', price: 3000, desc: 'Â¡EstÃ¡s en racha!', class: 'frame-fire' },
            { id: 'frame-matrix', name: 'Matrix', price: 5000, desc: 'Bienvenido al mundo real.', class: 'frame-matrix' }
        ];

        let currentUser = null;
        let currentCoins = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadUser();
            renderStore();
        });

        async function loadUser() {
            const localUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!localUser) { window.location.href = 'index.html'; return; }

            // Fetch fresh from Firebase if possible to confirm Balance
            if (window.getUserFromFirestore) {
                try {
                    currentUser = await window.getUserFromFirestore(localUser.id);
                } catch(e) { currentUser = localUser; }
            } else {
                currentUser = localUser;
            }

            // Init coins if not present
            if (!currentUser.coins) currentUser.coins = 0;
            currentCoins = currentUser.coins;

            document.getElementById('user-xp').textContent = `${currentCoins}`;
            document.querySelector('.xp-display p:first-child').textContent = "Tus Monedas";
        }

        // Removed calculateXP as it's no longer used for currency

        function renderStore() {
            const grid = document.getElementById('frames-grid');
            grid.innerHTML = '';
            
            // Normalize inventory
            const inventory = currentUser.inventory || { frames: [] };
            const ownedFrames = inventory.frames || [];
            const equipped = currentUser.equippedFrame;

            FRAMES.forEach(frame => {
                const isOwned = ownedFrames.includes(frame.id);
                const isEquipped = equipped === frame.class;
                const canAfford = currentCoins >= frame.price;

                const card = document.createElement('div');
                card.className = `glass-panel p-6 flex flex-col items-center text-center transition-all hover:-translate-y-2 ${isOwned ? 'border-accent' : canAfford ? 'border-gray-600' : 'border-red-900 opacity-60'}`;
                
                let btnHtml = '';
                if (isEquipped) {
                    btnHtml = `<button class="w-full py-2 bg-green-600/20 text-green-400 border border-green-500 rounded-lg font-bold cursor-default">Equipado</button>`;
                } else if (isOwned) {
                    btnHtml = `<button onclick="window.equipFrame('${frame.id}', '${frame.class}')" class="w-full py-2 bg-accent text-white rounded-lg font-bold hover:bg-accent-dark transition">Equipar</button>`;
                } else {
                    if (canAfford) {
                        btnHtml = `<button onclick="window.buyFrame('${frame.id}', ${frame.price})" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-bold transition flex justify-center items-center gap-2"><i data-lucide="shopping-cart" class="w-4 h-4"></i> Comprar</button>`;
                    } else {
                         btnHtml = `<button disabled class="w-full py-2 bg-gray-700 text-gray-400 rounded-lg font-bold cursor-not-allowed">Insuficiente</button>`;
                    }
                }

                card.innerHTML = `
                    <div class="frame-preview mb-4">
                        <img src="${currentUser.avatar || 'assets/default-avatar.png'}" class="${frame.class}">
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1">${frame.name}</h3>
                    <p class="text-sm text-gray-400 mb-4 h-10">${frame.desc}</p>
                    <div class="text-yellow-400 font-mono font-bold text-lg mb-6">${frame.price} ðŸª™</div>
                    <div class="mt-auto w-full">
                        ${btnHtml}
                    </div>
                `;
                
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        window.buyFrame = async (frameId, price) => {
            if (currentCoins < price) return;

            if(!confirm(`Â¿Gastar ${price} Monedas en este marco?`)) return;

            const inventory = currentUser.inventory || { frames: [] };
            inventory.frames = inventory.frames || [];
            
            if (inventory.frames.includes(frameId)) return;

            // Buy - Deduct Coins
            currentUser.coins = currentCoins - price;
            inventory.frames.push(frameId);

            // Save
            currentUser.inventory = inventory;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Sync Firebase
            try {
                const userRef = doc(db, 'users', currentUser.id);
                await updateDoc(userRef, {
                    inventory: inventory,
                    coins: currentUser.coins
                });
            } catch(e) { console.error(e); }

            showToast('Â¡Marco comprado!');
            
            // Update UI
            currentCoins = currentUser.coins;
            document.getElementById('user-xp').textContent = `${currentCoins}`;
            renderStore();
        };

        window.equipFrame = async (frameId, frameClass) => {
            currentUser.equippedFrame = frameClass;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
             // Sync Firebase
            try {
                const userRef = doc(db, 'users', currentUser.id);
                await updateDoc(userRef, {
                    equippedFrame: frameClass
                });
            } catch(e) { console.error(e); }

            showToast('Â¡Marco equipado!');
            renderStore();
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => {
                t.classList.add('opacity-0', 'translate-y-20');
            }, 2000);
        }

    </script>
</body>
</html>
