<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Code 418 - Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tokyo: {
                            bg: '#1a1b26',
                            fg: '#a9b1d6',
                            accent: '#7aa2f7',
                            dark: '#16161e',
                            green: '#9ece6a',
                            red: '#f7768e',
                            purple: '#bb9af7'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #1a1b26; color: #a9b1d6; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #16161e; }
        ::-webkit-scrollbar-thumb { background: #565f89; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #7aa2f7; }
    </style>
</head>
<body class="min-h-screen p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto mb-12 flex justify-between items-center border-b border-gray-800 pb-6">
        <div>
            <h1 class="text-3xl font-bold text-tokyo-accent mb-2">Admin Console <span class="text-xs align-top text-tokyo-purple">[GOD MODE]</span></h1>
            <p class="text-gray-500 font-mono text-sm">System Administration & AI Control</p>
        </div>
        <div class="flex gap-4">
             <a href="index.html" class="px-4 py-2 border border-gray-700 rounded hover:bg-tokyo-dark transition">Back to Academy</a>
             <div id="admin-status" class="px-3 py-1 bg-red-900/20 text-red-400 border border-red-900 rounded text-xs grid place-items-center">
                 NOT AUTHORIZED
             </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- LEFT COL: User Management (Placeholder for now) -->
        <section class="bg-tokyo-dark p-6 rounded-xl border border-gray-800">
            <h2 class="text-xl font-bold text-gray-200 mb-6 flex items-center gap-2">
                <span class="text-tokyo-green">ðŸ‘¥</span> User Management
            </h2>
            <div class="h-64 flex items-center justify-center text-gray-600 border-2 border-dashed border-gray-800 rounded-lg">
                User List Placeholder (Connecting to Firestore...)
            </div>
            <!-- Danger Zone -->
            <div class="mt-6 pt-6 border-t border-red-900/30">
                <h3 class="text-tokyo-red font-bold text-sm mb-2">DANGER ZONE</h3>
                <button class="px-4 py-2 bg-red-900/10 hover:bg-red-500 hover:text-white border border-red-900 text-red-500 rounded text-sm transition transition-all duration-300">
                    Purge All Users (Except Owners)
                </button>
            </div>
        </section>

        <!-- RIGHT COL: Gemini AI Agent -->
        <section class="bg-tokyo-dark p-6 rounded-xl border border-gray-800 ring-1 ring-tokyo-purple/20 relative overflow-hidden">
            <!-- Background Glow -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-tokyo-purple/5 blur-[100px] pointer-events-none"></div>

            <h2 class="text-xl font-bold text-gray-200 mb-6 flex items-center gap-2">
                <span class="text-tokyo-purple">ðŸ¤–</span> Gemini Oracle (Daily Challenge)
            </h2>

            <!-- Controls -->
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-xs font-mono text-gray-500 mb-1">Target Topic</label>
                    <input type="text" id="ai-topic" placeholder="e.g. Python Loops, CSS Flexbox, Logic Puzzles" 
                           class="w-full bg-[#1a1b26] border border-gray-700 rounded p-3 text-sm focus:border-tokyo-purple focus:outline-none transition">
                </div>
                <div class="flex gap-4">
                     <div class="w-1/2">
                        <label class="block text-xs font-mono text-gray-500 mb-1">Difficulty (1-5)</label>
                        <select id="ai-diff" class="w-full bg-[#1a1b26] border border-gray-700 rounded p-3 text-sm focus:border-tokyo-purple focus:outline-none">
                            <option value="1">1 - Recrue</option>
                            <option value="2">2 - Apprentice</option>
                            <option value="3" selected>3 - Adept</option>
                            <option value="4">4 - Expert</option>
                            <option value="5">5 - Architect (God)</option>
                        </select>
                     </div>
                     <div class="w-1/2 flex items-end">
                         <button id="btn-generate" class="w-full bg-tokyo-purple/10 hover:bg-tokyo-purple hover:text-white border border-tokyo-purple text-tokyo-purple font-bold py-3 rounded transition-all duration-300 flex justify-center items-center gap-2">
                             <span>âœ¨</span> Generate
                         </button>
                     </div>
                </div>
            </div>

            <!-- Output Console -->
            <div class="relative">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs font-mono text-gray-500">JSON Preview</label>
                    <button id="btn-publish" class="hidden px-3 py-1 bg-tokyo-green/10 text-tokyo-green border border-tokyo-green rounded text-xs hover:bg-tokyo-green hover:text-black transition">
                        Upload to Database
                    </button>
                </div>
                <pre id="ai-console" class="w-full h-80 bg-[#0f0f14] rounded-lg p-4 font-mono text-xs text-green-400 overflow-auto border border-gray-800 shadow-inner">
// Waiting for input...
// Press 'Generate' to invoke Gemini 1.5 Pro.
                </pre>
                
                <!-- Loading Overlay -->
                <div id="ai-loading" class="hidden absolute inset-0 bg-[#0f0f14]/80 flex flex-col items-center justify-center backdrop-blur-sm z-10">
                    <div class="w-8 h-8 border-2 border-tokyo-purple border-t-transparent rounded-full animate-spin mb-2"></div>
                    <span class="text-tokyo-purple text-xs animate-pulse">Consulting the Archives...</span>
                </div>
            </div>

        </section>

    </main>

    <!-- Modules -->
    <script type="module">
        import { ENV } from './assets/js/env.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { firebaseConfig } from './assets/js/firebase-config.js';

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- AUTH CHECK ---
        // Simple client-side gate (Not secure for real prod, but fine for prototype)
        const currentUser = JSON.parse(localStorage.getItem('user_data') || '{}');
        const adminStatus = document.getElementById('admin-status');

        if (currentUser.id === 'steven' || currentUser.id === 'amelia') {
            adminStatus.textContent = "AUTHORIZED: " + currentUser.name.toUpperCase();
            adminStatus.className = "px-3 py-1 bg-green-900/20 text-green-400 border border-green-900 rounded text-xs grid place-items-center";
        } else {
            document.body.innerHTML = "<div class='h-screen grid place-items-center text-red-500 font-mono'><h1>ACCESO DENEGADO</h1><p>ID de Sistema no reconocido. Incidente reportado.</p><a href='index.html' class='mt-4 underline text-gray-500'>Volver</a></div>";
        }

        // --- GEMINI LOGIC ---
        const btnGenerate = document.getElementById('btn-generate');
        const btnPublish = document.getElementById('btn-publish');
        const consoleOut = document.getElementById('ai-console');
        const loader = document.getElementById('ai-loading');
        
        let lastGeneratedChallenge = null;

        btnGenerate.addEventListener('click', async () => {
            const topic = document.getElementById('ai-topic').value || "Coding Logic";
            const diff = document.getElementById('ai-diff').value;

            // UI State
            loader.classList.remove('hidden');
            btnPublish.classList.add('hidden');
            consoleOut.textContent = "// Generating challenge on: " + topic + " (Diff: " + diff + ")...";

            const prompt = `
            You are an expert coding tutor AI. Create a generic Coding Challenge in JSON format.
            Topic: ${topic}
            Difficulty Level: ${diff}/5
            Language: Generic/Python/JS (Choose best fit for topic)

            Output ONLY valid JSON (no markdown, no backticks) with this structure:
            {
                "title": "Short catchy title",
                "description": "2-3 sentences explaining the task.",
                "storyContext": "A one-line lore flavor text (Anime/Cyberpunk style) relating to the task.",
                "language": "python" or "javascript",
                "difficulty": ${diff},
                "xp": ${diff * 50},
                "coins": ${diff * 100},
                "starterCode": "Code snippet...",
                "testCases": [
                    {"input": "arg1", "expected": "result1"},
                    {"input": "arg2", "expected": "result2"}
                ],
                "hints": ["hint1", "hint2"]
            }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${ENV.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                
                // Parse AI text (stripping markdown if any)
                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                lastGeneratedChallenge = JSON.parse(rawText);
                
                // Add timestamp ID
                const dateId = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                lastGeneratedChallenge.id = dateId;

                consoleOut.textContent = JSON.stringify(lastGeneratedChallenge, null, 2);
                btnPublish.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                consoleOut.textContent = "// ERROR: " + err.message + "\n\nRaw Response might be invalid JSON.";
            } finally {
                loader.classList.add('hidden');
            }
        });

        // --- PUBLISH LOGIC ---
        btnPublish.addEventListener('click', async () => {
            if (!lastGeneratedChallenge) return;
            
            try {
                consoleOut.textContent += "\n\n// Uploading to Firestore...";
                await setDoc(doc(db, "daily_challenges", "today"), lastGeneratedChallenge); // Saves as 'today' for easy fetch
                
                // Also save to archive with date
                await setDoc(doc(db, "daily_challenges", lastGeneratedChallenge.id), lastGeneratedChallenge);
                
                consoleOut.textContent += "\n// SUCCESS! Challenge is live.";
                alert("Challenge Published Successfully!");
            } catch (e) {
                consoleOut.textContent += "\n// FIREBASE ERROR: " + e.message;
            }
        });

    </script>
</body>
</html>
